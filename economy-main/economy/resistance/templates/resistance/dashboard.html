{% extends "base.html" %}
{% block title %}داشبورد{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- کارت‌های آمار -->
    <div class="stats-grid">
        <div class="stat-card">
            <i class="fa-solid fa-users stat-icon"></i>
            <h3>کاربران فعال</h3>
            <span>{{ users_count }}</span>
        </div>
        <div class="stat-card">
            <i class="fa-solid fa-vault stat-icon"></i>
            <h3>صندوق‌ها</h3>
            <span>{{ funds_count }}</span>
        </div>
        <div class="stat-card">
            <i class="fa-solid fa-hand-holding-heart stat-icon"></i>
            <h3>افراد محروم</h3>
            <span>{{ deprivation_count }}</span>
        </div>
        <div class="stat-card">
            <i class="fa-solid fa-file-lines stat-icon"></i>
            <h3>گزارش‌ها</h3>
            <span>{{ reports_count }}</span>
        </div>
    </div>

    <!-- نمودارها -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3>وضعیت دوره صندوق‌ها</h3>
            <canvas id="chartFundsCourse"></canvas>
        </div>
        <div class="chart-card">
            <h3>تعداد وام‌ها و موجودی صندوق‌ها</h3>
            <canvas id="chartFundLoans"></canvas>
        </div>
        <div class="chart-card">
            <h3>تعداد گزارش‌ها بر اساس تاریخ</h3>
            <canvas id="chartReportsTimeline"></canvas>
        </div>
    </div>

</div>

<style>
.dashboard-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin-top: 20px;
}

/* کارت آمار */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
}

.stat-card {
    background: var(--glass);
    backdrop-filter: blur(12px);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    text-align: center;
    color: var(--text-main);
    transition: transform 0.3s ease, background 0.3s ease;
}
.stat-card:hover {
    transform: translateY(-5px);
    background: var(--accent);
    color: #000;
}

.stat-icon {
    font-size: 30px;
    margin-bottom: 10px;
    color: var(--accent);
    transition: color 0.3s ease;
}
.stat-card:hover .stat-icon {
    color: #000;
}

.stat-card h3 { font-size: 16px; margin-bottom: 5px; }
.stat-card span { font-size: 24px; font-weight: bold; }

/* نمودارها */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
}

.chart-card {
    background: var(--glass);
    backdrop-filter: blur(12px);
    padding: 20px;
    border-radius: 15px;
    box-shadow: -1px -13px 25px rgba(196, 189, 189, 0.74);
    color: var(--text-main);
}

.chart-card h3 {
    text-align: center;
    margin-bottom: 15px;
    color: var(--accent);
}

/* ریسپانسیو */
@media(max-width:768px){
    .stats-grid, .charts-grid { grid-template-columns: 1fr; }
}
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // نمودار وضعیت دوره صندوق‌ها (دایره‌ای)
    const ctx1 = document.getElementById('chartFundsCourse').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: ['دارای دوره', 'بدون دوره'],
            datasets: [{
                label: 'وضعیت دوره',
                data: [{{ funds_with_course }}, {{ funds_without_course }}],
                backgroundColor: ['#C19A41', '#098368ff'],
                borderColor: ['#fff','#fff'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { color: 'var(--text-main)' } } }
        }
    });

    // نمودار تعداد وام‌ها و موجودی صندوق‌ها (میله‌ای)
    const ctx2 = document.getElementById('chartFundLoans').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: [{% for f in funds %}'{{ f.fund.name }}',{% endfor %}],
            datasets: [
                {
                    label: 'تعداد وام',
                    data: [{% for f in funds %}{{ f.NumberOfLoans }},{% endfor %}],
                    backgroundColor: '#C19A41'
                },
                {
                    label: 'موجودی',
                    data: [{% for f in funds %}{{ f.quantity }},{% endfor %}],
                    backgroundColor: '#1F3B2C'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: 'var(--text-main)' } } },
            scales: {
                y: { beginAtZero:true, ticks:{ color: 'var(--text-main)' } },
                x: { ticks:{ color: 'var(--text-main)' } }
            }
        }
    });

    // نمودار تعداد گزارش‌ها بر اساس تاریخ (خطی)
    const ctx3 = document.getElementById('chartReportsTimeline').getContext('2d');
    new Chart(ctx3, {
        type: 'line',
        data: {
            labels: [{% for d in reports_timeline %}'{{ d.date }}',{% endfor %}],
            datasets: [{
                label: 'تعداد گزارش',
                data: [{% for d in reports_timeline %}{{ d.count }},{% endfor %}],
                borderColor: '#C19A41',
                backgroundColor: 'rgba(193,154,65,0.2)',
                tension: 0.3,
                fill:true,
                pointBackgroundColor:'#1F3B2C'
            }]
        },
        options: {
            responsive:true,
            plugins:{ legend:{ labels:{ color:'var(--text-main)' } } },
            scales: {
                y: { ticks:{ color:'var(--text-main)', beginAtZero:true } },
                x: { ticks:{ color:'var(--text-main)' } }
            }
        }
    });

</script>
{% endblock %}
